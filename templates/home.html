{% extends "base.html" %}
{% block title %}Home{% endblock %}

{% block style %}
<link rel="stylesheet" href="/static/styles/home.css">
<link rel="stylesheet" href="/static/styles/postMeta.css">
<link rel="stylesheet" href="/static/styles/searchBar.css">
{% endblock %}

{% block content %}
{% from "includes/_formhelper.html" import render_field_no_label %}
<div class="container my-4">
  <div class="row justify-content-center">
    <div class="col-md-12">
      {{ flash() }}
    </div>

    <div class="col-md-3">
      <div class="sticky-top">
        <div>
          <a href="/addPost/{{sessionID}}" class="btn btn-danger w-100">Add Post</a>
        </div>

        <div class="my-3" id="trending-topics">
          <p class="font-weight-bold my-3">
            Trending Topics
          </p>

          <hr class="mx-auto">

          <p class="topic align-middle m-0">
            <span>#1</span>
            Python
          </p>

          <p class="topic align-middle m-0">
            <span>#2</span>
            Java
          </p>

          <p class="topic align-middle m-0">
            <span>#3</span>
            Stack
          </p>
        </div> <!--Trending Topics-->
      </div> <!--Stick--->
    </div> <!--Column-->


    <div class="col-md-9"> <!--For all the posts-->

      <form method="POST" class="form-group row">
        <div class="col-md-8">
          <div class="input-group">
            {{ render_field_no_label(searchBarForm.searchQuery, class="form-control rounded-pill py-2 pr-5 mr-1") }}
            <span class="input-group-append">
                <button class="btn rounded-pill input-group-text border-0 bg-transparent ml-n5"><i class="fa fa-search"></i></button>
            </span>
          </div>
        </div>
        <div class="col-md-4">
          {{ render_field_no_label(searchBarForm.topic, class= "form-control") }}
        </div>
      </form>

      {% for post in recentPosts %}
        <div class="post-preview my-3">
          <a href="/viewPost/{{ post.PostID }}/{{ sessionID}}">
            <h1 class="post-title">
              {{ post.Title }}
            </h1>
            <h2 class="post-subtitle">
              {{ post.Content }} <span style="color: #6a6a6a; font-size: 14px;">... See More</span>
            </h2>
          </a>
          <span class="post-meta">Posted by <a href="/profile/{{post.Username}}/{{ sessionID }}">{{ post.Username }}</a> on {{ post.DatetimePosted }} | <a href="/indivTopic/{{post.TopicID}}">{{ post.Topic }}</a></span>

          <span class="post-votes ml-auto float-right" id="post-votes-{{ post.PostID }}">
            <a onclick="postVote(this);" data-vote="1" data-post="{{ post.PostID }}"><i class="fa fa-arrow-up {% if post.UserVote==1 %}active{% endif %}"></i></a>
            <span id="postTotalVotes">{{ post.TotalVotes }}</span>
            <a onclick="postVote(this);" data-vote="-1" data-post="{{ post.PostID }}"><i class="fa fa-arrow-down {% if post.UserVote==-1 %}active{% endif %}"></i></a>
          </span> <!--Votes-->
        </div> <!--Post-->
      {% endfor %}

      <div>
        <a href="/topics" class="btn btn-danger w-100">View more posts</a>
      </div>
    </div> <!--Column-->

  </div> <!--Row-->
</div> <!--Container-->
{% endblock %}

{% block scripts %}
<script>
  function postVote(button) {
    var voteValue = button.getAttribute("data-vote");
    var postID = button.getAttribute("data-post");

    fetch('/postVote', {
      headers: new Headers({
        "content-type": "application/json"
      }),
      method: 'POST',
      body: JSON.stringify({
          "voteValue": voteValue,
          "postID": postID
      })
    })

    .then(function (response) { // At this point, Flask has printed our JSON
      response.json().then(function(data) {
        if (response.status === 401) {
          location.reload();
        }

        else {
          if (data['toggleUpvote']==true) {
            document.querySelector('#post-votes-' + data['postID'] + ' [data-vote="1"] i.fa-arrow-up').classList.toggle('active');
          }

          if (data['toggleDownvote']) {
            document.querySelector('#post-votes-' + data['postID'] + ' [data-vote="-1"] i.fa-arrow-down').classList.toggle('active');
          }

          document.querySelector('#post-votes-' + data['postID'] + ' #postTotalVotes').innerText = data['updatedVoteTotal'];
        }
      });
    }).catch(function (error) {
        console.log("Fetch error: " + error['message']);
    });
  }
</script>
{% endblock %}
